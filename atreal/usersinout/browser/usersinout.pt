<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/prefs_main_template/macros/master"
      i18n:domain="atreal.usersinout">

<head>
        <title tal:content="template/title">The title</title>
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
        <metal:style fill-slot="style_slot">
            <link rel="stylesheet" href="#" tal:attributes="href python:view.context.absolute_url() + '/++resource++atreal.userinout.resource/jquery-ui-1.8.23.custom.css'" />
            <style>
        .ui-combobox {
          position: relative;
          display: inline-block;
          font-size: 10pt;
        }
        .ui-menu{
          font-size: 10pt;
        }
        .ui-combobox-input {
          padding-bottom: 1px;
        }
        .ui-combobox-toggle {
          position: absolute;
          top: 0;
          bottom: 0;
          right: 0;
          margin-right: -34px;
          padding: 0;
        }
    </style>
        </metal:style>
        <metal:javascript fill-slot="javascript_head_slot">
            <script tal:attributes="src python:context.absolute_url() +'/++resource++atreal.userinout.resource/jquery-ui-1.8.23.custom.min.js'"></script>
            <script tal:attributes="src python:context.absolute_url() +'/++resource++atreal.userinout.resource/autocomplete.jquery-ui.js'"></script>
       </metal:javascript>
</head>

<metal:block metal:fill-slot="top_slot"
             tal:define="dummy python:request.set('disable_border', 1)" />

<body>
    <div metal:fill-slot="prefs_configlet_main" id="userinout-config" tal:define="eventos view/getVersusEventos">

      <h1 class="documentFirstHeading"
          i18n:translate="">
        Users In/Out
      </h1>

      <tal:trans i18n:domain="plone">
        <a href=""
          class="link-parent"
          tal:attributes="href string:$portal_url/plone_control_panel"
          i18n:translate="label_up_to_plone_setup">
          Up to Site Setup
        </a>
      </tal:trans>

      <p class="discreet" i18n:translate="">
          Users import and export as CSV files.
      </p>

      <form method="POST" action="#"  enctype="multipart/form-data"
            tal:attributes="action context/@@plone_context_state/current_page_url">
        
        <input type="hidden"
                 name="form.submitted"
                 value="1"
                 />

        <fieldset>

          <legend i18n:translate="">
            Comunidades
          </legend>

          <div class="field">    
            <label i18n:translate="">Comunidades</label>
            <div class="formHelp" i18n:translate="">
                Se uma comunidade for selecionada TODOS usuários contidos no arquivo CSV serão inseridos como PARTICIPANTE na respectiva comunidade (Opção independente da escolha da opção abaixo).
            </div>

            <select size="1" id="community_insert" name="community_insert">
                <option selected="selected" value="">Selecione uma comunidade</option>
                <tal:papel tal:repeat="cop view/get_all_cop">
                    <option value="" tal:attributes="value cop/value" tal:content="cop/title">COP</option>
                </tal:papel>
            </select>

          </div>

        </fieldset>

        <fieldset>

          <legend i18n:translate="">
            VER-SUS
          </legend>

          <div class="field">
            <label i18n:translate="">Vivência</label>
            <div class="formHelp" i18n:translate="">
                Se uma vivência for selecionada, para cada usuário contido no arquivo CSV será inserido um formulário de cadastro no VER-SUS e uma inscrição na Vivência selecionada.
            </div>

            <select size="1" id="versus_evento" name="versus_evento">
                <option selected="selected" value="">Selecione uma Vivência</option>
                <tal:papel tal:repeat="item eventos/eventos">
                    <option value="" tal:attributes="value item/value; filter item/filter" tal:content="item/title"></option>
                </tal:papel>
            </select>

          </div>
          <br />
          <div class="field">
            <label i18n:translate="">Opção de inserção</label>
            <div class="formHelp" i18n:translate="">
                Selecionar status da inscrição.
            </div>

            <input id="versus_option" type="radio" value="selecionado" name="versus_option">
                <label for="comunidade">Inscrição com o status 'Selecionado' e link no formulário de inscrição para a comunidade (Obrigatório selecionar comunidade acima)</label>
            <br />
            <input id="versus_option" type="radio" value="concluido" name="versus_option">
                <label for="certificado">Inscrição com o status 'Concluído' e geração de certificado (obrigatório preencher dados do certificado abaixo)</label>

          </div>

          <table class="listing">
            <tr>
              <th colspan="2">Dados Certificado</th>
            </tr>
            <tr>
                <td><label for="local">Local</label></td>
                <td><input type="text" name="local" id="local" value=""></td>
            </tr>
            <tr>
                <td>
                    <label for="periodo">Período</label>
                </td>
                <td>
                    <input type="text" name="periodo" id="periodo" value="">
                </td>
            </tr>
            <tr>
                <td><label for="carga_horaria">Carga horária</label></td>
                <td><input type="text" name="carga_horaria" id="carga_horaria" value=""></td>
            </tr>
            <tr>
                <td><label for="papel">Papel</label></td>
                <td>
                    <select name="papel" id="papel">
                      <option selected="selected" value="">Selecione uma papel</option>
                      <tal:papel tal:repeat="item eventos/papeis">
                        <option value="" tal:attributes="value item/id; filter item/filter" tal:content="item/nome"></option>
                      </tal:papel>
                    </select>
                 </td>
            </tr>
        </table>

        </fieldset>

        <fieldset>
          <legend i18n:translate="">
            Import
          </legend>

          <div class="field">
            <label i18n:translate="">Csv file</label>
            <div class="formHelp" i18n:translate="">
              Select your CSV file here. Please respect the syntax of the template available
              <tal:trans i18n:name="here">
                <a href="" i18n:translate=""
                   tal:attributes="href string:${context/absolute_url}/@@usersinout-getCSVTemplate">
                  here
                </a>
              </tal:trans>
            </div>
            <input type="file" name="csv_upload" />
          </div>

          <div class="formControls"
               i18n:domain="plone">
            
            <input class="destructive"
                   type="submit"
                   value="Cancel"
                   name="form.button.Cancel"
                   i18n:attributes="value label_cancel;"
                   />
            <input class="standalone"
                   type="submit"
                   value="Import"
                   name="form.button.Import"
                   i18n:attributes="value;"
                   />

          </div>

        </fieldset>

        <fieldset tal:condition="python:'users_results' in view.request">
          <legend i18n:translate="">
            Results
          </legend>

          <div class="field">  
              <div class="discreet">
                <tal:number content="view/request/users_results"/> 
                <tal:trans i18n:translate="">member(s) added.</tal:trans>
              </div>
              <div class="discreet">
                <tal:number content="view/request/groups_results"/> 
                <tal:trans i18n:translate="">group(s) added.</tal:trans>
              </div>
          </div>

          <tal:errors tal:condition="view/request/csverrors|nothing">
            
            <div class="field">  
              <label i18n:translate="">Errors detail</label>
              <div class="formHelp" i18n:translate="">
                You will find below the CSV lines that failed.
              </div>
              <textarea name="users_sheet_errors"
                        tal:content="view/request/form/users_sheet_errors|nothing">
              </textarea>
            </div>

            <div class="formControls">
              <input class="standalone"
                     type="submit"
                     value="Click here to get the errors as a CSV file"
                     name="form.button.CSVErrors"
                     i18n:attributes="value;"
                     />
            </div>

          </tal:errors>

        </fieldset>

        <fieldset>
          <legend i18n:translate="">
            Export
          </legend>
            
          <div class="formHelp" i18n:translate="">
            Click on the Export button in order to download the full list of the
            portal members as a CSV file. The CSV syntax is the same used in the
            template.
          </div>
          
          <div class="formControls"
               i18n:domain="plone">
            
            <input class="destructive"
                   type="submit"
                   value="Cancel"
                   name="form.button.Cancel"
                   i18n:attributes="value label_cancel;"
                   />
            <input class="standalone"
                   type="submit"
                   value="Export"
                   name="form.button.Export"
                   i18n:attributes="value;"
                   />

          </div>

        </fieldset>

        <input tal:replace="structure context/@@authenticator/authenticator" />
      </form>
       <script>
                function change_papel() {
                    var evento = $("#versus_evento option:selected");
                    $('select[id="papel"]').empty();
                    $(options_papel).each( function () {
                        var item = $(this).attr('filter');
                        if (item == evento.attr('filter') || $(this).val() == '')  {
                          $('select[id="papel"]').append(jq(this).clone());
                        }
                    });
                }
                $(document).ready(function(){
                    options_papel = $('select[id="papel"] option');
                    change_papel();
                    $("#versus_evento").change(function(event) { change_papel(); });
                    $("#community_insert").combobox();
                });
            </script>
    </div>
</body>

</html>

